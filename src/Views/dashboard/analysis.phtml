<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lise de An√∫ncios - MELI 360</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="//unpkg.com/alpinejs" defer></script>
</head>
<body class="bg-gray-100">
    
    <?php require_once BASE_PATH . '/src/Views/layouts/header.phtml'; ?>

    <main class="container mx-auto px-4 lg:px-6 py-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">üìä An√°lise de An√∫ncios</h1>

        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Sincronizar Contas</h2>
            <div class="space-y-3">
                <?php foreach ($mlConnections as $conn): ?>
                    <div class="flex justify-between items-center p-3 border-b last:border-b-0">
                        <div>
                            <p class="font-medium"><?= htmlspecialchars($conn['nickname']); ?> <span class="text-xs text-gray-500">(<?= htmlspecialchars($conn['ml_user_id']); ?>)</span></p>
                            <p class="text-xs text-gray-500">Status Sincroniza√ß√£o: <span class="font-semibold"><?= htmlspecialchars($conn['sync_status']); ?></span></p>
                        </div>
                        <a href="/dashboard/sync/<?= $conn['ml_user_id']; ?>" class="px-3 py-1 text-sm text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i> Iniciar Sincroniza√ß√£o
                        </a>
                    </div>
                <?php endforeach; ?>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">
                üìã Seus An√∫ncios (Conta Ativa: <span class="text-indigo-600 font-bold"><?= $_SESSION['active_ml_nickname'] ?? 'Nenhuma Selecionada'; ?></span>)
            </h2>
            
            <?php if (isset($activeMlAccountId)): ?>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">An√∫ncio</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estoque</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendas</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sa√∫de</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <?php if (empty($anuncios)): ?>
                                <tr>
                                    <td colspan="7" class="text-center py-10 text-gray-500">
                                        <p>Nenhum an√∫ncio encontrado para esta conta.</p>
                                        <?php if (!empty($mlConnections)): ?>
                                            <p class="mt-2">Clique em "Iniciar Nova Sincroniza√ß√£o" para buscar seus an√∫ncios.</p>
                                        <?php endif; ?>
                                    </td>
                                </tr>
                            <?php else: ?>
                                <?php foreach ($anuncios as $anuncio): ?>
                                    <tr class="hover:bg-gray-50 transition-colors">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0 h-12 w-12">
                                                    <img class="h-12 w-12 rounded-md object-cover" src="<?= htmlspecialchars($anuncio['thumbnail']) ?>" alt="Thumbnail">
                                                </div>
                                                <div class="ml-4">
                                                    <div class="text-sm font-medium text-gray-900 max-w-xs truncate" title="<?= htmlspecialchars($anuncio['title']) ?>"><?= htmlspecialchars($anuncio['title']) ?></div>
                                                    <div class="text-xs text-gray-500"><?= htmlspecialchars($anuncio['ml_item_id']) ?></div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><?= htmlspecialchars($anuncio['sku'] ?? 'N/A') ?></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900"><?= htmlspecialchars($anuncio['stock'] ?? 0) ?></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900"><?= htmlspecialchars($anuncio['total_sales'] ?? 0) ?></td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <?php 
                                                $health = ($anuncio['health'] ?? 0) * 100;
                                                $healthColor = 'bg-red-500';
                                                if ($health > 85) $healthColor = 'bg-green-500';
                                                elseif ($health > 60) $healthColor = 'bg-yellow-500';
                                            ?>
                                            <div class="w-24 bg-gray-200 rounded-full h-2.5">
                                                <div class="<?= $healthColor ?> h-2.5 rounded-full" style="width: <?= $health ?>%" title="Sa√∫de: <?= number_format($health, 0) ?>%"></div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full <?= $anuncio['status'] === 'active' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800' ?>">
                                                <?= htmlspecialchars($anuncio['status']) ?>
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <a href="<?= htmlspecialchars($anuncio['permalink']) ?>" class="text-indigo-600 hover:text-indigo-900" target="_blank" title="Ver no Mercado Livre">
                                                <i class="fas fa-external-link-alt"></i>
                                            </a>
                                        </td>
                                    </tr>
                                <?php endforeach; ?>
                            <?php endif; ?>
                        </tbody>
                    </table>
                </div>
                <!-- Pagina√ß√£o aqui -->
            <?php else: ?>
                <div class="text-center text-gray-500 py-10">
                    <p>Por favor, selecione uma conta na <a href="/dashboard" class="text-blue-600 hover:underline">Vis√£o Geral</a> para come√ßar.</p>
                </div>
            <?php endif; ?>
        </div>
    </main>
</body>
</html>